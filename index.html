<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Color Prediction Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-color: #111827;
            --card-color: #1f2937;
            --primary-color: #3b82f6;
            --secondary-color: #10b981;
            --text-color: #f3f4f6;
            --muted-text-color: #9ca3af;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        .card {
            background-color: var(--card-color);
            border: 1px solid #374151;
        }
        .btn-primary {
            background-color: var(--primary-color);
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: var(--secondary-color);
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #059669;
        }
        .input-field {
            background-color: #374151;
            border: 1px solid #4b5563;
        }
        .result-big { color: #f59e0b; }
        .result-small { color: #8b5cf6; }
        .result-red { color: #ef4444; }
        .result-green { color: #22c55e; }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .toast {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 1;
            left: 50%;
            bottom: 30px;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.5s, visibility 0.5s;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="p-4 md:p-6">
    <div class="max-w-4xl mx-auto space-y-6">
        <!-- Header -->
        <header class="text-center space-y-2">
            <h1 class="text-3xl md:text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400">AI Prediction Assistant</h1>
            <p class="text-base text-muted-text-color">Analyze trends and predict outcomes for WinGo</p>
        </header>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left Column: Controls & Prediction -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Server Connection Card -->
                <div class="card p-5 rounded-xl">
                    <div class="flex items-center gap-3 mb-4">
                        <i data-lucide="server" class="text-blue-400"></i>
                        <h2 class="text-xl font-semibold">Server Connection</h2>
                    </div>
                    <div class="space-y-3">
                        <input id="serverLink" type="text" placeholder="Enter Server Link" class="w-full p-2 rounded-md input-field focus:outline-none focus:ring-2 focus:ring-primary-color" value="https://www.jalwagames2.com/">
                        <input id="gameUid" type="text" placeholder="Enter Game UID" class="w-full p-2 rounded-md input-field focus:outline-none focus:ring-2 focus:ring-primary-color" value="WinGo_30S">
                        <button id="connectBtn" class="w-full text-white font-semibold py-2 px-4 rounded-md btn-primary flex items-center justify-center gap-2">
                            <i data-lucide="zap"></i>
                            <span>Connect</span>
                        </button>
                         <p id="connectionStatus" class="text-xs text-center text-muted-text-color mt-2">Status: Disconnected</p>
                    </div>
                </div>

                <!-- Prediction Card -->
                <div class="card p-5 rounded-xl">
                    <div class="flex items-center gap-3 mb-4">
                       <i data-lucide="brain-circuit" class="text-emerald-400"></i>
                       <h2 class="text-xl font-semibold">Get Prediction</h2>
                    </div>
                    <div class="space-y-3">
                        <input id="periodInput" type="number" placeholder="Last 3 digits of Period No." class="w-full p-2 rounded-md input-field focus:outline-none focus:ring-2 focus:ring-primary-color">
                        <button id="predictBtn" class="w-full text-white font-semibold py-2 px-4 rounded-md btn-secondary flex items-center justify-center gap-2">
                            <i data-lucide="wand-2"></i>
                            <span>Predict Next Outcome</span>
                        </button>
                    </div>
                     <!-- Prediction Result -->
                    <div id="predictionResult" class="mt-5 text-center hidden">
                         <div id="loader" class="loader mx-auto my-4 hidden"></div>
                         <div id="resultContent">
                            <p class="text-muted-text-color mb-2">AI Suggestion:</p>
                            <div class="flex justify-center items-center gap-4">
                                <span id="sizePrediction" class="text-3xl font-bold"></span>
                                <span id="colorPrediction" class="text-3xl font-bold"></span>
                            </div>
                            <p class="text-sm text-muted-text-color mt-2">Confidence: <span id="confidence" class="font-medium text-white"></span></p>
                         </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Data Management -->
            <div class="lg:col-span-2 space-y-6">
                <div class="card p-5 rounded-xl">
                    <div class="flex items-center gap-3 mb-4">
                        <i data-lucide="database" class="text-amber-400"></i>
                        <h2 class="text-xl font-semibold">Historical Data</h2>
                    </div>
                     <!-- Add New Number Form -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
                        <input id="newPeriod" type="number" placeholder="Full Period No." class="md:col-span-1 p-2 rounded-md input-field focus:outline-none focus:ring-2 focus:ring-primary-color">
                        <input id="newResult" type="number" placeholder="Result (0-9)" min="0" max="9" class="md:col-span-1 p-2 rounded-md input-field focus:outline-none focus:ring-2 focus:ring-primary-color">
                        <button id="addNumberBtn" class="md:col-span-1 text-white font-semibold py-2 px-4 rounded-md btn-primary flex items-center justify-center gap-2">
                            <i data-lucide="plus-circle"></i>
                            <span>Add Data</span>
                        </button>
                    </div>
                     <!-- Data Table -->
                    <div class="overflow-auto max-h-96 pr-2">
                        <table class="w-full text-sm text-left">
                            <thead class="text-xs text-muted-text-color uppercase">
                                <tr>
                                    <th scope="col" class="px-4 py-2">Period</th>
                                    <th scope="col" class="px-4 py-2">Result</th>
                                    <th scope="col" class="px-4 py-2">Size</th>
                                    <th scope="col" class="px-4 py-2">Color</th>
                                    <th scope="col" class="px-4 py-2 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <!-- Data rows will be inserted here by JavaScript -->
                                <tr id="no-data-row"><td colspan="5" class="text-center py-4 text-muted-text-color">No data available. Add some results to begin.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="toast" class="toast"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        lucide.createIcons();

        // --- DOM Elements ---
        const connectBtn = document.getElementById('connectBtn');
        const connectionStatus = document.getElementById('connectionStatus');
        const predictBtn = document.getElementById('predictBtn');
        const periodInput = document.getElementById('periodInput');
        const predictionResult = document.getElementById('predictionResult');
        const sizePrediction = document.getElementById('sizePrediction');
        const colorPrediction = document.getElementById('colorPrediction');
        const confidence = document.getElementById('confidence');
        const loader = document.getElementById('loader');
        const resultContent = document.getElementById('resultContent');
        const addNumberBtn = document.getElementById('addNumberBtn');
        const newPeriod = document.getElementById('newPeriod');
        const newResult = document.getElementById('newResult');
        const historyTableBody = document.getElementById('historyTableBody');
        const noDataRow = document.getElementById('no-data-row');
        const toast = document.getElementById('toast');

        // --- Firebase Setup ---
        let db, auth;
        let historicalData = [];
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-color-pred-app';
        
        try {
            const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug');
            
            (async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                listenToData();
            })();

        } catch(e) {
            console.error("Firebase initialization failed:", e);
            showToast("Error connecting to database.", "error");
        }


        // --- UI Functions ---
        const showToast = (message, type = 'success') => {
            toast.textContent = message;
            toast.className = `toast show ${type === 'error' ? 'bg-red-500' : 'bg-gray-800'}`;
            setTimeout(() => { toast.className = toast.className.replace("show", ""); }, 3000);
        };

        const renderHistory = () => {
            historyTableBody.innerHTML = '';
             if (historicalData.length === 0) {
                historyTableBody.appendChild(noDataRow);
                return;
            }
            
            const sortedData = [...historicalData].sort((a, b) => b.period - a.period);

            sortedData.forEach(item => {
                const { size, color } = getResultDetails(item.result);
                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-700';
                tr.innerHTML = `
                    <td class="px-4 py-2">${item.period}</td>
                    <td class="px-4 py-2 font-bold">${item.result}</td>
                    <td class="px-4 py-2 font-semibold ${size === 'Big' ? 'result-big' : 'result-small'}">${size}</td>
                    <td class="px-4 py-2 font-semibold ${color === 'Red' ? 'result-red' : 'result-green'}">${color}</td>
                    <td class="px-4 py-2 text-right">
                        <button class="delete-btn text-red-500 hover:text-red-400" data-id="${item.id}">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </td>
                `;
                historyTableBody.appendChild(tr);
            });
            lucide.createIcons();
        };

        // --- Data Logic ---
        const listenToData = () => {
            const dataCollection = collection(db, `artifacts/${appId}/public/data/wino_results`);
            const q = query(dataCollection);
            onSnapshot(q, (snapshot) => {
                historicalData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderHistory();
            }, (error) => {
                console.error("Error fetching data from Firestore:", error);
                showToast("Error fetching live data.", "error");
            });
        };

        const addData = async (period, result) => {
            if (!period || result === null || result < 0 || result > 9) {
                showToast("Invalid input. Please check period and result.", "error");
                return;
            }
            try {
                const dataCollection = collection(db, `artifacts/${appId}/public/data/wino_results`);
                await addDoc(dataCollection, {
                    period: Number(period),
                    result: Number(result),
                    timestamp: new Date()
                });
                newPeriod.value = '';
                newResult.value = '';
                showToast("Data added successfully!");
            } catch (error) {
                console.error("Error adding document: ", error);
                showToast("Failed to add data.", "error");
            }
        };

        const deleteData = async (id) => {
             try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/wino_results`, id));
                showToast("Data point deleted.");
            } catch (error) {
                console.error("Error deleting document: ", error);
                showToast("Failed to delete data.", "error");
            }
        };

        // --- Prediction AI Logic ---
        const getResultDetails = (num) => {
            const size = num >= 5 ? 'Big' : 'Small';
            const color = [1, 3, 5, 7, 9].includes(num) ? 'Green' : 'Red';
            return { size, color };
        };

        const analyzeTrends = (data) => {
            let sizeScores = { 'Big': 0, 'Small': 0 };
            let colorScores = { 'Red': 0, 'Green': 0 };

            if (data.length < 5) return { sizeScores, colorScores };

            // 1. Recent Frequency (last 20 results)
            const recentData = data.slice(0, 20);
            let bigCount = 0, smallCount = 0, redCount = 0, greenCount = 0;
            recentData.forEach(item => {
                const details = getResultDetails(item.result);
                if(details.size === 'Big') bigCount++; else smallCount++;
                if(details.color === 'Red') redCount++; else greenCount++;
            });

            if (bigCount > smallCount) sizeScores['Big'] += 2; else sizeScores['Small'] += 2;
            if (redCount > greenCount) colorScores['Red'] += 2; else colorScores['Green'] += 2;
            
            // 2. Streak Analysis (last 5 results)
            const lastFive = data.slice(0, 5).map(item => getResultDetails(item.result));
            if (lastFive.every(d => d.size === lastFive[0].size)) { // Size streak
                 sizeScores[lastFive[0].size === 'Big' ? 'Small' : 'Big'] += 3; // Predict streak break
            }
            if (lastFive.every(d => d.color === lastFive[0].color)) { // Color streak
                 colorScores[lastFive[0].color === 'Red' ? 'Green' : 'Red'] += 3; // Predict streak break
            }

            // 3. Pattern Matching (check for alternating patterns)
            if (lastFive.length >= 4) {
                const s1 = lastFive[0].size, s2 = lastFive[1].size, s3 = lastFive[2].size, s4 = lastFive[3].size;
                if(s1 !== s2 && s1 === s3 && s2 === s4) { // B-S-B-S pattern
                    sizeScores[s2] += 4; // Predict continuation
                }
            }
            
            return { sizeScores, colorScores };
        };

        const predict = () => {
            if (historicalData.length < 10) {
                showToast("Not enough data to predict. Please add at least 10 results.", "error");
                return;
            }
            
            loader.style.display = 'block';
            resultContent.style.display = 'none';
            predictionResult.style.display = 'block';

            setTimeout(() => {
                const sortedData = [...historicalData].sort((a, b) => b.period - a.period);
                const { sizeScores, colorScores } = analyzeTrends(sortedData);

                const predictedSize = sizeScores['Big'] > sizeScores['Small'] ? 'Big' : 'Small';
                const predictedColor = colorScores['Red'] > colorScores['Green'] ? 'Red' : 'Green';
                
                const totalSizeScore = sizeScores['Big'] + sizeScores['Small'];
                const confidenceSize = totalSizeScore > 0 ? (Math.max(sizeScores['Big'], sizeScores['Small']) / totalSizeScore * 100).toFixed(0) : 50;

                sizePrediction.textContent = predictedSize;
                sizePrediction.className = `text-3xl font-bold ${predictedSize === 'Big' ? 'result-big' : 'result-small'}`;

                colorPrediction.textContent = predictedColor;
                colorPrediction.className = `text-3xl font-bold ${predictedColor === 'Red' ? 'result-red' : 'result-green'}`;
                
                confidence.textContent = `${confidenceSize}%`;
                
                loader.style.display = 'none';
                resultContent.style.display = 'block';

            }, 1500); // Simulate AI thinking
        };

        // --- Event Listeners ---
        connectBtn.addEventListener('click', () => {
            connectionStatus.textContent = 'Status: Connecting...';
            connectionStatus.classList.remove('text-red-500');
            connectionStatus.classList.add('text-yellow-500');
            setTimeout(() => {
                connectionStatus.textContent = 'Status: Connected';
                connectionStatus.classList.remove('text-yellow-500');
                connectionStatus.classList.add('text-green-500');
                showToast("Successfully connected to the server!");
            }, 1000);
        });

        predictBtn.addEventListener('click', () => {
             if (!periodInput.value || periodInput.value.length < 3) {
                showToast("Please enter the last 3 digits of the period.", "error");
                return;
            }
            predict();
        });

        addNumberBtn.addEventListener('click', () => {
            addData(newPeriod.value, newResult.value);
        });
        
        historyTableBody.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.delete-btn');
            if(deleteButton) {
                const id = deleteButton.dataset.id;
                if(confirm('Are you sure you want to delete this entry?')) {
                     deleteData(id);
                }
            }
        });

    </script>
</body>
</html>

